<!doctype html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>RoomList</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
    />
    <style>
      .roomModal {
        position: absolute;
        display: none;
        justify-content: center;
        top: 0;
        left: 0;

        width: 100%;
        height: 100%;

        background-color: rgba(0, 0, 0, 0.4);
      }

      .modal_body {
        position: absolute;
        top: 50%;

        width: 100%;
        height: 800px;

        padding: 40px;

        text-align: center;

        background-color: rgb(255, 255, 255);
        border-radius: 10px;
        box-shadow: 0 2px 3px 0 rgba(34, 36, 38, 0.15);

        transform: translateY(-50%);
      }
    </style>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
  </head>

  <body class="d-flex flex-column align-items-center mt-5">
    <!-- Button trigger modal -->
    <div class="d-flex">
      <button
        type="button"
        class="btn btn-primary mx-1"
        style="width: 150px"
        data-bs-toggle="modal"
        data-bs-target="#exampleModal"
      >
        방만들기
      </button>
      <button
        type="button"
        class="btn btn-primary mx-1"
        style="width: 150px"
        onclick="getRoomList()"
      >
        방조사
      </button>
    </div>
    <div>
      <span>userList</span>
      <div id="list"></div>
    </div>
    <div class="d-flex flex-wrap" style="width: 800px" id="main"></div>
    <!-- Modal -->
    <div
      class="modal fade"
      id="exampleModal"
      tabindex="-1"
      aria-labelledby="exampleModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h1 class="modal-title fs-5" id="exampleModalLabel">채팅방 설정</h1>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            제목:<input type="text" name="title" /><br />
            비밀번호:<input type="password" name="password" /><br />
            라운드:<input
              type="number"
              name="round"
              value="2"
              min="2"
              max="8"
            /><br />
            <input type="number" name="total" value="4" min="2" max="8" />
            인원수

            <select id="type">
              <option value="1" selected>끝말잇기</option>
              <option value="2">쿵쿵따</option>
            </select>
            <br />
            <input type="checkbox" value="품어" name="option" />품어
            <input type="checkbox" value="매너" name="option" />매너
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Close
            </button>
            <button
              type="button"
              class="btn btn-primary"
              onclick="createRoom()"
            >
              Save changes
            </button>
          </div>
        </div>
      </div>
    </div>
    <!--room-->

    <div class="roomModal">
      <div class="modal_body d-flex flex-column">
        <div class="d-flex justify-content-center">
          <div
            class="border border-dark radius p-3"
            style="width: 800px; height: 600px; background-color: white"
            id="chat"
          ></div>
          <div
            class="border border-dark radius p-3"
            style="width: 400px; height: 600px; background-color: white"
            id="roomList"
          ></div>
        </div>
        <div class="mt-3">
          <input type="text" name="chat" /><button onclick="sendChat()">
            입력창
          </button>
        </div>
        <div>
          <button onclick="exitRoom()">나가기</button
          ><button onclick="getInfo()">정보얻기</button>
          <button onclick="ready()">준비</button>
          <button onclick="start()">시작</button>
          <button onclick="round()">라운드</button>
        </div>
      </div>
    </div>

    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
      crossorigin="anonymous"
    ></script>
  </body>
  <script src="/socket.io/socket.io.js"></script>

  <script>
    const socket = io('/wakttu');
    socket.on('list', (data) => {
      let list = document.querySelector('#list');
      list.innerText = '';
      for (let x in data) {
        let div = document.createElement('div');
        div.innerText = data[x].name;
        list.appendChild(div);
      }
    });
    socket.on('createRoom', (data) => {
      const modal = document.querySelector('.roomModal');
      modal.style.display = 'flex';
      modal.dataset['id'] = data.id;
      socket.emit('enter', data.id);
    });
    socket.on('roomList', (data) => {
      const id = document.querySelector('#main');
      id.innerHTML = '';
      for (let i = 0; i < data.length; i++) {
        let div = document.createElement('div');
        div.innerHTML = `<div class="card m-2 p-2" style="width: 360px;" data-id="${data[i].id}" onclick="enterRoom(this)">
            <div class="card-body">
                <h5 class="card-title">${data[i].title}</h5>
                <p class="card-text">round:${data[i].round}|total:${data[i].users.length}/${data[i].total}|option:${data[i].option}|</p>

            </div>
        </div>`;
        id.appendChild(div);
      }
    });
    function createRoom() {
      const inputs = document.querySelectorAll('input');
      const select = document.querySelector('#type option[selected]').value;
      let data = {
        option: [],
      };
      for (let i = 0; i < inputs.length; i++) {
        if (inputs[i].name === 'chat') continue;
        if (inputs[i].name === 'option') {
          data['option'].push(inputs[i].value);
        } else if (inputs[i].name === 'round' || inputs[i].name === 'total') {
          data[inputs[i].name] = +inputs[i].value;
        } else {
          data[inputs[i].name] = inputs[i].value;
        }
      }
      data['type'] = +select;

      $('#exampleModal').modal('hide');

      socket.emit('createRoom', data);
    }

    function enterRoom(div) {
      const modal = document.querySelector('.roomModal');
      modal.style.display = 'flex';
      const roomId = div.dataset['id'];
      modal.dataset['id'] = roomId;
      socket.emit('enter', roomId);
    }

    socket.on('enter', (data) => {
      const users = data.users;
      let roomList = document.querySelector('#roomList');
      roomList.innerText = '';

      for (let i = 0; i < users.length; i++) {
        let div = document.createElement('div');
        div.innerText = `${users[i].name}`;
        roomList.appendChild(div);
      }
    });

    function exitRoom() {
      const modal = document.querySelector('.roomModal');
      const roomId = modal.dataset['id'];
      modal.dataset['id'] = '';
      modal.style.display = 'none';
      socket.emit('exit', roomId);
    }

    socket.on('exit', (data) => {
      const users = data.users;
      let roomList = document.querySelector('#roomList');
      roomList.innerText = '';

      for (let i = 0; i < users.length; i++) {
        let div = document.createElement('div');
        div.innerText = `${users[i].name}`;
        roomList.appendChild(div);
      }
    });

    function sendChat() {
      const modal = document.querySelector('.roomModal');
      let chat = document.querySelector('input[name = "chat"]');
      const roomId = modal.dataset['id'];
      let data = {
        roomId: roomId,
        chat: chat.value,
      };
      socket.emit('chat', data);
      chat.value = '';
    }

    socket.on('chat', (data) => {
      const div = document.createElement('div');
      div.innerText = `${data.name} : ${data.chat}`;
      document.querySelector('#chat').appendChild(div);
    });

    function getRoomList() {
      socket.emit('roomList');
    }

    function getInfo() {
      socket.emit('info');
    }
    socket.on('info', (data) => {
      console.log(data.user, data.game, data.roomInfo);
      console.log(socket);
    });

    function ready() {
      const modal = document.querySelector('.roomModal');
      const roomId = modal.dataset['id'];
      socket.emit('ready', roomId);
    }

    socket.on('ready', (data) => {
      console.log(data);
    });

    function start() {
      const modal = document.querySelector('.roomModal');
      const roomId = modal.dataset['id'];
      socket.emit('start', roomId);
    }

    socket.on('start', (data) => {
      const div = document.createElement('div');
      div.innerText = `주제어 : ${data.keyword._id}`;
      document.querySelector('#chat').appendChild(div);
    });

    function round() {
      const modal = document.querySelector('.roomModal');
      const roomId = modal.dataset['id'];
      socket.emit('round', roomId);
    }

    socket.on('round', (data) => {
      console.log(data);
    });

    socket.on('turn', (data) => {
      console.log(data);
    });
  </script>
</html>
